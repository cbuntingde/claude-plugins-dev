/**
 * Interactive API Explorer Generator
 * Creates an interactive API explorer UI similar to Swagger UI
 */

import fs from 'fs/promises';
import path from 'path';
import YAML from 'yaml';
import type { OpenAPISpec, GeneratorResult } from '../types.js';

interface APIExplorerOptions {
  theme?: 'light' | 'dark';
  tryItOutEnabled?: boolean;
  defaultModelsExpandDepth?: number;
}

export async function createAPIExplorer(
  openApiSpecPath: string,
  outputPath: string,
  options: APIExplorerOptions = {}
): Promise<GeneratorResult> {
  const filesGenerated: string[] = [];
  const warnings: string[] = [];

  try {
    // Parse OpenAPI spec
    const spec = await parseOpenAPISpec(openApiSpecPath);

    // Create output directory
    await fs.mkdir(outputPath, { recursive: true });

    // Generate HTML explorer
    const explorerHTML = generateExplorerHTML(spec, options);
    const indexPath = path.join(outputPath, 'index.html');
    await fs.writeFile(indexPath, explorerHTML, 'utf-8');
    filesGenerated.push(indexPath);

    // Copy OpenAPI spec to output for loading
    const specOutputPath = path.join(outputPath, 'openapi.json');
    await fs.writeFile(specOutputPath, JSON.stringify(spec, null, 2), 'utf-8');
    filesGenerated.push(specOutputPath);

    // Generate CSS
    const cssPath = path.join(outputPath, 'explorer.css');
    await fs.writeFile(cssPath, EXPLORER_CSS, 'utf-8');
    filesGenerated.push(cssPath);

    // Generate JavaScript
    const jsPath = path.join(outputPath, 'explorer.js');
    await fs.writeFile(jsPath, EXPLORER_JS, 'utf-8');
    filesGenerated.push(jsPath);

    return {
      success: true,
      outputPath,
      filesGenerated,
      warnings: warnings.length > 0 ? warnings : undefined
    };
  } catch (error) {
    return {
      success: false,
      outputPath,
      filesGenerated,
      errors: [error instanceof Error ? error.message : 'Unknown error']
    };
  }
}

async function parseOpenAPISpec(specPath: string): Promise<OpenAPISpec> {
  const content = await fs.readFile(specPath, 'utf-8');
  const ext = path.extname(specPath).toLowerCase();

  if (ext === '.yaml' || ext === '.yml') {
    return YAML.parse(content) as OpenAPISpec;
  } else if (ext === '.json') {
    return JSON.parse(content) as OpenAPISpec;
  } else {
    throw new Error(`Unsupported file format: ${ext}. Use .json, .yaml, or .yml`);
  }
}

function generateExplorerHTML(spec: OpenAPISpec, options: APIExplorerOptions): string {
  const theme = options.theme || 'light';
  const tryItOutEnabled = options.tryItOutEnabled !== false;
  const defaultModelsExpandDepth = options.defaultModelsExpandDepth || 1;

  return `<!DOCTYPE html>
<html lang="en" data-theme="${theme}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${spec.info.title} - API Explorer</title>
  <link rel="stylesheet" href="explorer.css">
</head>
<body>
  <div class="explorer">
    <header class="explorer-header">
      <h1>${spec.info.title}</h1>
      <p class="version">v${spec.info.version}</p>
      ${spec.info.description ? `<p class="description">${spec.info.description}</p>` : ''}
    </header>

    <div class="explainer-content">
      <aside class="sidebar">
        <div class="search">
          <input type="text" id="search" placeholder="Search endpoints...">
        </div>
        <nav class="endpoints-nav" id="endpointsNav">
          <!-- Navigation will be generated by JavaScript -->
        </nav>
      </aside>

      <main class="main-content" id="mainContent">
        <div class="welcome">
          <h2>Welcome to ${spec.info.title}</h2>
          <p>Select an endpoint from the sidebar to view its details and try it out.</p>
        </div>
      </main>
    </div>
  </div>

  <script>
    window.API_SPEC = ${JSON.stringify(spec)};
    window.TRY_IT_OUT_ENABLED = ${tryItOutEnabled};
    window.DEFAULT_MODELS_EXPAND_DEPTH = ${defaultModelsExpandDepth};
  </script>
  <script src="explorer.js"></script>
</body>
</html>`;
}

const EXPLORER_CSS = `
:root {
  --color-primary: #0066cc;
  --color-success: #28a745;
  --color-warning: #ffc107;
  --color-danger: #dc3545;
  --color-info: #17a2b8;
  --color-bg: #ffffff;
  --color-text: #333333;
  --color-border: #dee2e6;
  --color-sidebar-bg: #f8f9fa;
  --color-code-bg: #f5f5f5;
  --color-header-bg: #0066cc;
  --color-header-text: #ffffff;
  --spacing-unit: 1rem;
}

[data-theme="dark"] {
  --color-primary: #4d9fff;
  --color-bg: #1a1a1a;
  --color-text: #e0e0e0;
  --color-border: #444;
  --color-sidebar-bg: #2d2d2d;
  --color-code-bg: #252525;
  --color-header-bg: #0052a3;
  --color-header-text: #ffffff;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.6;
  color: var(--color-text);
  background: var(--color-bg);
}

.explorer {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.explorer-header {
  background: var(--color-header-bg);
  color: var(--color-header-text);
  padding: 1.5rem 2rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.explorer-header h1 {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.version {
  font-size: 1rem;
  opacity: 0.9;
  margin-bottom: 0.5rem;
}

.description {
  font-size: 0.9rem;
  opacity: 0.95;
}

.explainer-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  width: 320px;
  background: var(--color-sidebar-bg);
  border-right: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.search {
  padding: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.search input {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: var(--color-bg);
  color: var(--color-text);
  font-size: 0.9rem;
}

.search input:focus {
  outline: none;
  border-color: var(--color-primary);
}

.endpoints-nav {
  flex: 1;
  overflow-y: auto;
  padding: 1rem 0;
}

.endpoint-group {
  margin-bottom: 1rem;
}

.endpoint-group-title {
  padding: 0.5rem 1rem;
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  color: var(--color-secondary);
  letter-spacing: 0.5px;
}

.endpoint-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.9rem;
}

.endpoint-item:hover {
  background: rgba(0, 102, 204, 0.1);
}

.endpoint-item.active {
  background: rgba(0, 102, 204, 0.2);
  border-left: 3px solid var(--color-primary);
}

.method-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  min-width: 60px;
  text-align: center;
}

.method-badge.GET { background: var(--color-success); color: white; }
.method-badge.POST { background: var(--color-primary); color: white; }
.method-badge.PUT { background: var(--color-warning); color: black; }
.method-badge.DELETE { background: var(--color-danger); color: white; }
.method-badge.PATCH { background: var(--color-info); color: white; }

.main-content {
  flex: 1;
  overflow-y: auto;
  padding: 2rem;
}

.welcome {
  text-align: center;
  padding: 4rem 2rem;
}

.welcome h2 {
  margin-bottom: 1rem;
  color: var(--color-primary);
}

.endpoint-detail {
  max-width: 900px;
  margin: 0 auto;
}

.endpoint-header {
  background: var(--color-sidebar-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.endpoint-title {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.endpoint-path {
  font-family: 'Courier New', monospace;
  font-size: 1.1rem;
  color: var(--color-text);
}

.endpoint-description {
  margin-bottom: 1rem;
  line-height: 1.6;
}

.section {
  background: var(--color-sidebar-bg);
  border: 1px solid var(--color-border);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.2rem;
  margin-bottom: 1rem;
  color: var(--color-primary);
}

.parameters-table,
.responses-table {
  width: 100%;
  border-collapse: collapse;
}

.parameters-table th,
.parameters-table td,
.responses-table th,
.responses-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid var(--color-border);
}

.parameters-table th,
.responses-table th {
  background: var(--color-bg);
  font-weight: 600;
}

.required-badge {
  background: var(--color-danger);
  color: white;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.try-it-out {
  background: var(--color-success);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: background 0.2s;
}

.try-it-out:hover {
  background: #218838;
}

.try-it-out:disabled {
  background: var(--color-secondary);
  cursor: not-allowed;
}

.input-group {
  margin-bottom: 1rem;
}

.input-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.input-group input,
.input-group textarea,
.input-group select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  background: var(--color-bg);
  color: var(--color-text);
  font-family: inherit;
}

.input-group input:focus,
.input-group textarea:focus,
.input-group select:focus {
  outline: none;
  border-color: var(--color-primary);
}

.response-area {
  background: var(--color-code-bg);
  border: 1px solid var(--color-border);
  border-radius: 4px;
  padding: 1rem;
  margin-top: 1rem;
  max-height: 400px;
  overflow: auto;
}

.response-area pre {
  margin: 0;
  font-family: 'Courier New', monospace;
  font-size: 0.9rem;
}

code {
  background: var(--color-code-bg);
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

@media (max-width: 768px) {
  .sidebar {
    width: 100%;
    position: fixed;
    left: -100%;
    top: 120px;
    height: calc(100vh - 120px);
    transition: left 0.3s;
    z-index: 1000;
  }

  .sidebar.open {
    left: 0;
  }

  .main-content {
    padding: 1rem;
  }
}
`;

const EXPLORER_JS = `
// Load API specification
const spec = window.API_SPEC;

// Initialize the explorer
function initExplorer() {
  generateNavigation();
  setupSearch();
  setupEventListeners();
}

// Generate navigation from OpenAPI spec
function generateNavigation() {
  const nav = document.getElementById('endpointsNav');
  const groups = {};

  // Group endpoints by tag
  for (const [path, pathItem] of Object.entries(spec.paths)) {
    for (const [method, operation] of Object.entries(pathItem)) {
      if (['get', 'post', 'put', 'delete', 'patch'].includes(method)) {
        const tags = operation.tags || ['Other'];
        const tag = tags[0];

        if (!groups[tag]) {
          groups[tag] = [];
        }

        groups[tag].push({
          path,
          method,
          operation
        });
      }
    }
  }

  // Generate HTML
  let html = '';
  for (const [tag, endpoints] of Object.entries(groups)) {
    html += '<div class="endpoint-group">';
    html += '<div class="endpoint-group-title">' + tag + '</div>';

    for (const endpoint of endpoints) {
      html += '<div class="endpoint-item" data-path="' + endpoint.path + '" data-method="' + endpoint.method + '">';
      html += '<span class="method-badge ' + endpoint.method.toUpperCase() + '">' + endpoint.method.toUpperCase() + '</span>';
      html += '<span class="endpoint-path">' + endpoint.path + '</span>';
      html += '</div>';
    }

    html += '</div>';
  }

  nav.innerHTML = html;

  // Add click handlers
  nav.querySelectorAll('.endpoint-item').forEach(item => {
    item.addEventListener('click', () => {
      const path = item.dataset.path;
      const method = item.dataset.method;
      showEndpointDetail(path, method, item);
    });
  });
}

// Setup search functionality
function setupSearch() {
  const searchInput = document.getElementById('search');

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    const items = document.querySelectorAll('.endpoint-item');

    items.forEach(item => {
      const path = item.dataset.path.toLowerCase();
      const match = path.includes(query);
      item.style.display = match ? 'flex' : 'none';
    });
  });
}

// Show endpoint detail
function showEndpointDetail(path, method, navItem) {
  // Update active state
  document.querySelectorAll('.endpoint-item').forEach(item => {
    item.classList.remove('active');
  });
  navItem.classList.add('active');

  const pathItem = spec.paths[path];
  const operation = pathItem[method];

  // Generate detail view
  const html = generateEndpointDetail(path, method, operation);
  document.getElementById('mainContent').innerHTML = html;

  // Setup try it out
  if (window.TRY_IT_OUT_ENABLED) {
    setupTryItOut(path, method, operation);
  }
}

// Generate endpoint detail HTML
function generateEndpointDetail(path, method, operation) {
  let html = '<div class="endpoint-detail">';
  html += '<div class="endpoint-header">';
  html += '<div class="endpoint-title">';
  html += '<span class="method-badge ' + method.toUpperCase() + '">' + method.toUpperCase() + '</span>';
  html += '<span class="endpoint-path">' + path + '</span>';
  html += '</div>';

  if (operation.summary) {
    html += '<h3>' + operation.summary + '</h3>';
  }

  if (operation.description) {
    html += '<p class="endpoint-description">' + operation.description + '</p>';
  }

  html += '</div>';

  // Parameters
  if (operation.parameters && operation.parameters.length > 0) {
    html += '<div class="section">';
    html += '<h3 class="section-title">Parameters</h3>';
    html += '<table class="parameters-table">';
    html += '<thead><tr><th>Name</th><th>Type</th><th>In</th><th>Required</th><th>Description</th></tr></thead>';
    html += '<tbody>';

    operation.parameters.forEach(param => {
      html += '<tr>';
      html += '<td><code>' + param.name + '</code></td>';
      html += '<td>' + (param.schema?.type || 'string') + '</td>';
      html += '<td>' + param.in + '</td>';
      html += '<td>' + (param.required ? '<span class="required-badge">Required</span>' : 'Optional') + '</td>';
      html += '<td>' + (param.description || '') + '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    html += '</div>';
  }

  // Request body
  if (operation.requestBody) {
    html += '<div class="section">';
    html += '<h3 class="section-title">Request Body</h3>';
    if (operation.requestBody.description) {
      html += '<p>' + operation.requestBody.description + '</p>';
    }
    html += '</div>';
  }

  // Responses
  html += '<div class="section">';
  html += '<h3 class="section-title">Responses</h3>';
  html += '<table class="responses-table">';
  html += '<thead><tr><th>Status</th><th>Description</th></tr></thead>';
  html += '<tbody>';

  for (const [status, response] of Object.entries(operation.responses)) {
    html += '<tr>';
    html += '<td><code>' + status + '</code></td>';
    html += '<td>' + response.description + '</td>';
    html += '</tr>';
  }

  html += '</tbody></table>';
  html += '</div>';

  // Try it out form
  if (window.TRY_IT_OUT_ENABLED) {
    html += '<div class="section">';
    html += '<h3 class="section-title">Try it out</h3>';
    html += '<div id="tryItOutForm"></div>';
    html += '<button class="try-it-out" id="executeBtn">Execute</button>';
    html += '<div class="response-area" id="responseArea" style="display:none;"></div>';
    html += '</div>';
  }

  html += '</div>';

  return html;
}

// Setup try it out functionality
function setupTryItOut(path, method, operation) {
  const form = document.getElementById('tryItOutForm');
  if (!form) return;

  let html = '';

  // Generate parameter inputs
  if (operation.parameters && operation.parameters.length > 0) {
    operation.parameters.forEach(param => {
      html += '<div class="input-group">';
      html += '<label>' + param.name + (param.required ? ' *' : '') + '</label>';

      if (param.schema?.type === 'boolean') {
        html += '<select name="' + param.name + '">';
        html += '<option value="">Select...</option>';
        html += '<option value="true">true</option>';
        html += '<option value="false">false</option>';
        html += '</select>';
      } else {
        html += '<input type="text" name="' + param.name + '" placeholder="' + (param.schema?.type || 'string') + '">';
      }

      html += '</div>';
    });
  }

  form.innerHTML = html;

  // Setup execute button
  document.getElementById('executeBtn').addEventListener('click', () => {
    executeRequest(path, method, operation);
  });
}

// Execute API request
async function executeRequest(path, method, operation) {
  const btn = document.getElementById('executeBtn');
  const responseArea = document.getElementById('responseArea');

  btn.disabled = true;
  btn.textContent = 'Executing...';

  try {
    // Build URL
    let url = spec.servers[0].url + path;

    // Replace path parameters
    if (operation.parameters) {
      operation.parameters.forEach(param => {
        if (param.in === 'path') {
          const input = document.querySelector('[name="' + param.name + '"]');
          if (input && input.value) {
            url = url.replace('{' + param.name + '}', encodeURIComponent(input.value));
          }
        }
      });
    }

    // Build request options
    const options: RequestInit = {
      method: method.toUpperCase()
    };

    // Add query parameters
    if (operation.parameters) {
      const queryParams = operation.parameters
        .filter(p => p.in === 'query')
        .map(p => {
          const input = document.querySelector('[name="' + p.name + '"]');
          return input && input.value ? encodeURIComponent(p.name) + '=' + encodeURIComponent(input.value) : null;
        })
        .filter(Boolean);

      if (queryParams.length > 0) {
        url += '?' + queryParams.join('&');
      }
    }

    // Add headers
    const headers: Record<string, string> = {};
    if (operation.parameters) {
      operation.parameters
        .filter(p => p.in === 'header')
        .forEach(p => {
          const input = document.querySelector('[name="' + p.name + '"]');
          if (input && input.value) {
            headers[p.name] = input.value;
          }
        });
    }
    headers['Content-Type'] = 'application/json';
    options.headers = headers;

    // Execute request
    const response = await fetch(url, options);
    const contentType = response.headers.get('content-type') || '';
    let responseBody;

    if (contentType.includes('application/json')) {
      responseBody = await response.json();
      responseBody = JSON.stringify(responseBody, null, 2);
    } else {
      responseBody = await response.text();
    }

    // Display response
    responseArea.style.display = 'block';
    responseArea.innerHTML = '<pre><code>Status: ' + response.status + ' ' + response.statusText + '\\n\\n' + responseBody + '</code></pre>';
  } catch (error) {
    responseArea.style.display = 'block';
    responseArea.innerHTML = '<pre><code>Error: ' + error.message + '</code></pre>';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Execute';
  }
}

// Setup event listeners
function setupEventListeners() {
  // Theme toggle (if implemented)
  // Mobile menu toggle (if implemented)
}

// Initialize on DOM load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initExplorer);
} else {
  initExplorer();
}
`;
