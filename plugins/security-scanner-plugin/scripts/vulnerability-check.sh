#!/bin/bash
# Vulnerability check script - checks for specific vulnerability types
# Focuses on a single vulnerability type for targeted scanning

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# Default values
VULN_TYPE="sql-injection"
SCAN_PATH="."
SEVERITY="high"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        sql-injection|xss|secrets|command-injection)
            VULN_TYPE="$1"
            shift
            ;;
        --path)
            SCAN_PATH="$2"
            shift 2
            ;;
        --severity)
            SEVERITY="$2"
            shift 2
            ;;
        --fix)
            AUTO_FIX=true
            shift
            ;;
        --help|-h)
            echo "Usage: $0 [vulnerability-type] [options]"
            echo ""
            echo "Vulnerability types:"
            echo "  sql-injection        Check for SQL injection patterns"
            echo "  xss                  Check for XSS vulnerabilities"
            echo "  secrets              Check for hardcoded secrets"
            echo "  command-injection    Check for command injection"
            echo ""
            echo "Options:"
            echo "  --path <path>        Path to scan"
            echo "  --severity <level>   Minimum severity"
            echo "  --fix                Attempt auto-fix"
            echo "  --help, -h           Show help"
            exit 0
            ;;
        *)
            SCAN_PATH="$1"
            shift
            ;;
    esac
done

# Vulnerability patterns by type
declare -A VULN_PATTERNS

case "$VULN_TYPE" in
    sql-injection)
        VULN_PATTERNS["String concatenation in query"]='query\s*=\s*[`"'\''].*\$.*[`"'\'']'
        VULN_PATTERNS["String concat in execute"]='execute\s*\(\s*[`"'\''].*\+.*[`"'\'']'
        VULN_PATTERNS["SQL with + operator"]='SELECT.*FROM.*WHERE.*\+'
        ;;
    xss)
        VULN_PATTERNS["Direct innerHTML assignment"]='innerHTML\s*=\s*'
        VULN_PATTERNS["document.write usage"]='document\.write\s*\('
        VULN_PATTERNS["Dangerous eval"]='eval\s*\([^)]*innerHTML'
        ;;
    secrets)
        VULN_PATTERNS["Hardcoded password"]='password\s*=\s*['\"'][^\"\']{8,}['\"]'
        VULN_PATTERNS["Hardcoded API key"]='api[_-]?key\s*=\s*['\"'][^\"\']{20,}['\"]'
        VULN_PATTERNS["Hardcoded secret key"]='secret[_-]?key\s*=\s*['\"'][^\"\']{20,}['\"]'
        VULN_PATTERNS["Hardcoded token"]='token\s*=\s*['\"'][^\"\']{30,}['\"]'
        VULN_PATTERNS["AWS Access Key"]='AKIA[0-9A-Z]{16}'
        VULN_PATTERNS["GitHub Token"]='ghp_[a-zA-Z0-9]{36}'
        VULN_PATTERNS["Stripe Key"]='sk-[a-zA-Z0-9]{48}'
        ;;
    command-injection)
        VULN_PATTERNS["exec with interpolation"]='exec\s*\(\s*[^)]*\+'
        VULN_PATTERNS["subprocess with shell=true"]='subprocess.*shell\s*=\s*true'
        VULN_PATTERNS["os.system usage"]='os\.system\s*\('
        VULN_PATTERNS["shell=True in process"]='Process.*shell\s*=\s*true'
        ;;
    *)
        echo -e "${RED}Unknown vulnerability type: $VULN_TYPE${NC}"
        exit 1
        ;;
esac

SCAN_EXTENSIONS="\.js$|\.ts$|\.jsx$|\.tsx$|\.py$|\.java$|\.go$|\.php$|\.rb$|\.cs$"
SKIP_DIRS="node_modules|vendor|\.git|__pycache__|\.venv|venv|env|dist|build"

print_header() {
    echo ""
    echo -e "${BLUE}Vulnerability Check: ${VULN_TYPE^^}${NC}"
    echo -e "${BLUE}Path: $SCAN_PATH${NC}"
    echo ""
}

main() {
    print_header

    if [ ! -d "$SCAN_PATH" ]; then
        echo -e "${RED}Error: Path not found: $SCAN_PATH${NC}"
        exit 1
    fi

    findings=()
    count=0

    while IFS= read -r file; do
        [ ! -f "$file" ] && continue

        while IFS= read -r line; do
            line_num="${line%%:*}"
            code="${line#*:}"

            for vuln_desc in "${!VULN_PATTERNS[@]}"; do
                pattern="${VULN_PATTERNS[$vuln_desc]}"
                if echo "$code" | grep -Eqi "$pattern" 2>/dev/null; then
                    findings+=("$vuln_desc|$file|$line_num|$code")
                    ((count++))
                fi
            done
        done < <(grep -En "${VULN_PATTERNS[*]}" "$file" 2>/dev/null || true)
    done < <(find "$SCAN_PATH" -type f -regextype posix-extended -regex ".*($SCAN_EXTENSIONS)" 2>/dev/null | grep -Ev "($SKIP_DIRS)" | head -500)

    if [ $count -eq 0 ]; then
        echo -e "${GREEN}✓ No vulnerabilities of type '$VULN_TYPE' found!${NC}"
    else
        echo "Found $count potential issues:"
        echo ""

        for finding in "${findings[@]}"; do
            IFS='|' read -r type fpath fline code <<< "$finding"
            echo -e "${RED}File:${NC} $fpath:$fline"
            echo -e "${RED}Type:${NC} $type"
            echo -e "${RED}Code:${NC} $code"
            echo ""
        done

        echo -e "${YELLOW}Recommendations:${NC}"
        case "$VULN_TYPE" in
            sql-injection)
                echo "  - Use parameterized queries (prepared statements)"
                echo "  - Use ORM libraries with proper escaping"
                echo "  - Never concatenate user input into queries"
                ;;
            xss)
                echo "  - Use textContent instead of innerHTML when possible"
                echo "  - Sanitize user input with DOMPurify"
                echo "  - Use React's default escaping"
                ;;
            secrets)
                echo "  - Move secrets to environment variables"
                echo "  - Use secret management services (AWS Secrets Manager, HashiCorp Vault)"
                echo "  - Add .env files to .gitignore"
                ;;
            command-injection)
                echo "  - Use subprocess with array arguments (no shell=True)"
                echo "  - Avoid eval() with user input"
                echo "  - Use command-escape libraries"
                ;;
        esac
        echo ""
    fi

    echo "═════════════════════════════════════════════"
}

main

# Exit with error if vulnerabilities found
if [ $count -gt 0 ]; then
    exit 1
fi
exit 0